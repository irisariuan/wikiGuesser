---
export const prerender = false;
import Game from "../../components/Game";
import GameFooter from "../../components/GameFooter.astro";
import MainLayout from "../../layout/MainLayout.astro";
import { decodeFromBase64 } from "../../lib/utils";
import { extractDataFromWiki } from "../../lib/web";
import { getOrCreateChallengeAndReturnId } from "../../lib/server/challenge";

const { title } = Astro.params;
if (!title) return Astro.redirect("/");
const finalTitle = decodeFromBase64(title);
if (!finalTitle) return Astro.redirect("/internalError");
const text = await extractDataFromWiki(finalTitle);
const id = await getOrCreateChallengeAndReturnId(finalTitle);
if (!text) return Astro.redirect("/internalError");
---

<MainLayout subtitle="Game">
	<div class="flex flex-col items-center gap-4">
		{text && <Game client:load text={text} encodedTitle={title} id={id} />}
		<GameFooter title={text.title} extract={text.extract} />
	</div>
</MainLayout>
